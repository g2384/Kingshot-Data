<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Game Events Timeline</title>
    <link rel="stylesheet" href="timeline.css">
</head>

<body>
    <div class="container">
        <!-- Left Control Panel -->
        <div class="control-panel">
            <h2>Timeline Controls</h2>

            <div class="control-group">
                <label for="startWeekday">Start Day Weekday:</label>
                <select id="startWeekday">
                    <option value="0" selected>Sunday</option>
                    <option value="1">Monday</option>
                    <option value="2">Tuesday</option>
                    <option value="3">Wednesday</option>
                    <option value="4">Thursday</option>
                    <option value="5">Friday</option>
                    <option value="6">Saturday</option>
                </select>
            </div>

            <!-- Info Button -->
            <button class="info-button" onclick="openEventInfoModal()">
                Event Information & Exclusions
            </button>

            <!-- Event Legend -->
            <div class="legend">
                <h3>Event Categories</h3>
                <div class="legend-item">
                    <div class="color-box one-off"></div>
                    <span>One-off Events</span>
                </div>
                <div class="legend-item">
                    <div class="color-box solo"></div>
                    <span>Solo Events</span>
                </div>
                <div class="legend-item">
                    <div class="color-box alliance"></div>
                    <span>Alliance Events</span>
                </div>
                <div class="legend-item">
                    <div class="color-box hog"></div>
                    <span>Hall of Governors</span>
                </div>
                <div class="legend-item">
                    <div class="color-box online"></div>
                    <span>Online Events</span>
                </div>
                <div class="legend-item">
                    <div class="color-box power-up"></div>
                    <span>Power-up Events</span>
                </div>
            </div>

            <!-- Filter Controls -->
            <div class="filter-controls">
                <h3>Quick Filters</h3>
                <button class="filter-button active" onclick="toggleAllEvents(true)">Show All</button>
                <button class="filter-button" onclick="toggleAllEvents(false)">Hide All</button>
                <button class="filter-button" onclick="toggleByCategory('one-off')">One-off</button>
                <button class="filter-button" onclick="toggleByCategory('solo')">Solo</button>
                <button class="filter-button" onclick="toggleByCategory('alliance')">Alliance</button>
                <button class="filter-button" onclick="toggleByCategory('hog')">HoG</button>
                <button class="filter-button" onclick="toggleByCategory('online')">Online</button>
                <button class="filter-button" onclick="toggleByCategory('power-up')">Power-up</button>
            </div>

            <!-- Event List -->
            <div class="event-list">
                <h3>Event Visibility</h3>
                <div id="eventListContainer"></div>
            </div>
        </div>

        <!-- Right Timeline Panel -->
        <div class="timeline-panel">
            <div class="timeline-container" id="timelineContainer">
                <table class="timeline-table" id="timelineTable">
                    <thead id="timelineHeader">
                        <!-- Headers will be generated by JavaScript -->
                    </thead>
                    <tbody id="timelineBody">
                        <!-- Timeline rows will be generated by JavaScript -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Modal Popup -->
    <div id="eventInfoModal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Event Information & Exclusions</h2>
                <button class="modal-close" onclick="closeEventInfoModal()">&times;</button>
            </div>
            <div class="modal-body">
                <h3>Why Some Events Are Not Displayed</h3>
                <p>This timeline focuses on regular, predictable events that players can plan for. Some events are
                    excluded for the following reasons:</p>

                <div class="excluded-event">
                    <div class="excluded-event-title">üèõÔ∏è Sanctuary Battle</div>
                    <div class="excluded-event-reason">
                        Sanctuary Battle is a weekly event with a consistent recurrence.
                        However, its exact weekday trigger varies by server and cannot be reliably predicted for new
                        servers due to limited data.
                        For instance, if both servers are launched on Sunday, one might see the event on Tuesday, while
                        the other may encounter it on Sunday.
                    </div>
                </div>

                <div class="excluded-event">
                    <div class="excluded-event-title">üèõÔ∏è Alliance Championship</div>
                    <div class="excluded-event-reason">
                        Alliance Championship is a weekly event that lasts 7 days. It first begins on the
                        Monday following the server's ~10th day and continues to repeat every Monday thereafter.
                    </div>
                </div>

                <div class="excluded-event">
                    <div class="excluded-event-title">üéØ Special Limited Events</div>
                    <div class="excluded-event-reason">
                        Holiday events, anniversary celebrations, and other limited-time events are announced separately
                        and don't follow regular patterns.
                        These are typically communicated through official game announcements or suddenly appears.
                    </div>
                </div>

                <h3>Planning Your Activities</h3>
                <p>Use this timeline to:</p>
                <ul>
                    <li>Plan your resource management around upcoming events</li>
                    <li>Coordinate alliance activities</li>
                    <li>Optimize your daily login rewards and participation</li>
                    <li>Prepare for power-up events by saving materials in advance</li>
                </ul>
            </div>
        </div>
    </div>

    <script>
        // Sample JSON data structure
        const sampleEventsData = {
            "events": [
                {
                    "id": 1,
                    "title": "7 Daily Sign-in Gift",
                    "duration": 7,
                    "isRepeating": false,
                    "occurrenceInterval": 0,
                    "firstOccurrenceDay": 1,
                    "category": "one-off",
                    "requirements": []
                },
                {
                    "id": 2,
                    "title": "Path of Growth",
                    "duration": 7,
                    "isRepeating": false,
                    "occurrenceInterval": 0,
                    "firstOccurrenceDay": 1,
                    "category": "one-off",
                    "hasStages": true,
                    "stages": [
                        { "day": 1, "note": "" },
                        { "day": 2, "note": "" },
                        { "day": 3, "note": "" },
                        { "day": 4, "note": "Require Conquest Skill Books, Expedition Skill Manuals" },
                        { "day": 5, "note": "Require 800 minutes of any Speedup" },
                        { "day": 6, "note": "" },
                        { "day": 7, "note": "" }
                    ],
                    "requirements": ["TC Lv. 5"]
                },
                {
                    "id": 3,
                    "title": "Burst of Life",
                    "duration": 7,
                    "isRepeating": false,
                    "occurrenceInterval": 0,
                    "firstOccurrenceDay": 1,
                    "category": "one-off",
                    "requirements": []
                },
                {
                    "id": 4,
                    "title": "Desert Trial",
                    "duration": 3,
                    "isRepeating": false,
                    "occurrenceInterval": 0,
                    "firstOccurrenceDay": 3,
                    "category": "solo",
                    "isFixed": true,
                    "fixedColumn": 3,
                    "requirements": []
                },
                {
                    "id": 6,
                    "title": "Hall of Governors",
                    "duration": 5,
                    "isRepeating": false,
                    "occurrenceInterval": 0,
                    "firstOccurrenceDay": 6,
                    "category": "hog",
                    "hasStages": true,
                    "stages": [
                        { "day": 1, "note": "Raise 1 Power through Construction, Raise 1 Power through Research" },
                        { "day": 2, "note": "Hero shards" },
                        { "day": 3, "note": "Promote troops" },
                        { "day": 4, "note": "Stamina" },
                        { "day": 5, "note": "Raise 1 Power through Construction, Raise 1 Power through Research, promote troops" },
                        { "day": 6, "note": "" },
                        { "day": 7, "note": "" }
                    ],
                    "isFixed": true,
                    "fixedColumn": 0,
                    "requirements": ["1st"]
                },
                {
                    "id": 7,
                    "title": "Hero Roulette",
                    "duration": 3,
                    "isRepeating": false,
                    "occurrenceInterval": 0,
                    "firstOccurrenceDay": 7,
                    "category": "hog",
                    "isFixed": true,
                    "fixedColumn": 1,
                    "requirements": ["1st, Saul"]
                },
                {
                    "id": 11,
                    "title": "Desert Trial",
                    "duration": 3,
                    "isRepeating": true,
                    "occurrenceInterval": 14,
                    "firstOccurrenceDay": 11,
                    "firstOccurrenceWeekday": "Wednesday",
                    "category": "solo",
                    "isFixed": true,
                    "fixedColumn": 3,
                    "requirements": []
                },
                {
                    "id": 12,
                    "title": "Defeat Nearby Beasts",
                    "duration": 3,
                    "isRepeating": true,
                    "occurrenceInterval": 14,
                    "firstOccurrenceDay": 15,
                    "firstOccurrenceWeekday": "Tuesday",
                    "category": "solo",
                    "isFixed": true,
                    "fixedColumn": 3,
                    "requirements": []
                },
                {
                    "id": 12,
                    "title": "Alliance Mobilization",
                    "duration": 7,
                    "isRepeating": true,
                    "occurrenceInterval": 14,
                    "firstOccurrenceDay": 7,
                    "firstOccurrenceWeekday": "Monday",
                    "category": "alliance",
                    "isFixed": true,
                    "fixedColumn": 2,
                    "requirements": ["Alliance Rank 20+"]
                },
                {
                    "id": 13,
                    "title": "Fishing Tournament",
                    "duration": 3,
                    "isRepeating": true,
                    "occurrenceInterval": 30,
                    "firstOccurrenceDay": 9,
                    "category": "solo",
                    "requirements": []
                },
                {
                    "id": 14,
                    "title": "Viking Vengeance",
                    "duration": 3,
                    "isRepeating": true,
                    "occurrenceInterval": 14,
                    "firstOccurrenceDay": 7,
                    "firstOccurrenceWeekday": "Tuesday",
                    "category": "online",
                    "requirements": []
                },
                {
                    "id": 15,
                    "title": "Steel Edge",
                    "duration": 2,
                    "isRepeating": true,
                    "occurrenceInterval": 14,
                    "firstOccurrenceDay": 11,
                    "category": "power-up",
                    "maxOccurrences": 1,
                    "isFixed": true,
                    "fixedColumn": 1,
                    "note": "Use Forgehammer, Gear Enhancement, Exclusive Gear Widget, Gather Resources",
                    "requirements": []
                },
                {
                    "id": 16,
                    "title": "Cesares Fury",
                    "duration": 3,
                    "isRepeating": true,
                    "occurrenceInterval": 21,
                    "firstOccurrenceDay": 11,
                    "category": "solo",
                    "requirements": []
                },
                {
                    "id": 17,
                    "title": "Plan Your City",
                    "duration": 2,
                    "isRepeating": true,
                    "occurrenceInterval": 14,
                    "firstOccurrenceDay": 13,
                    "category": "power-up",
                    "maxOccurrences": 1,
                    "isFixed": true,
                    "fixedColumn": 1,
                    "note": "Raise 1 Power through Construction, Raise 1 Power through Research",
                    "requirements": []
                },
                {
                    "id": 18,
                    "title": "Power Up",
                    "duration": 2,
                    "isRepeating": true,
                    "occurrenceInterval": 14,
                    "firstOccurrenceDay": 15,
                    "category": "power-up",
                    "maxOccurrences": 1,
                    "isFixed": true,
                    "fixedColumn": 1,
                    "note": "Raise 1 Power through Construction, Raise 1 Power through Research, promote troops",
                    "requirements": []
                },
                {
                    "id": 19,
                    "title": "Hall of Governors",
                    "duration": 6,
                    "isRepeating": false,
                    "occurrenceInterval": 0,
                    "firstOccurrenceDay": 15,
                    "firstOccurrenceWeekday": "Monday",
                    "category": "hog",
                    "hasStages": true,
                    "stages": [
                        { "day": 1, "note": "Raise 1 Power through Construction, Raise 1 Power through Research" },
                        { "day": 2, "note": "Play Hero Roulette, Use 1 Rare Hero Shard to ascend Heroes, Use 1 Epic Hero Shard to ascend Heroes, Use 1 Mythic Hero Shard to ascend Heroes, Gather 50 Bread in the Wilderness, Gather 50 Wood in the Wilderness, Gather 10 Stone in the Wilderness, Gather 2 Iron in the Wilderness" },
                        { "day": 3, "note": "Raise 1 Power by training/promoting troops" },
                        { "day": 4, "note": "Gather 50 Bread in the Wilderness, Gather 50 Wood in the Wilderness, Gather 10 Stone in the Wilderness, Gather 2 Iron in the Wilderness, Raise 1 Power through Research" },
                        { "day": 5, "note": "Use 1 Hero Gear Forgehammer(s), Use 100 Hero Gear Enhancement XP, Use 1 Widget for Hero Exclusive Gear, Raise 1 Power through Construction, Raise 1 Power through Research, Raise 1 Power by training/promoting troops" },
                        { "day": 6, "note": "Raise Governor Gear max score by 1, Raise 1 Power through Construction, Raise 1 Power through Research, Raise 1 Power by training/promoting troops" }
                    ],
                    "isFixed": true,
                    "fixedColumn": 0,
                    "requirements": ["2nd"]
                },
                {
                    "id": 21,
                    "title": "Swordland Showdown",
                    "duration": 7,
                    "isRepeating": true,
                    "occurrenceInterval": 14,
                    "firstOccurrenceDay": 15,
                    "category": "online",
                    "firstOccurrenceWeekday": "Monday",
                    "isFixed": false,
                    "note": "",
                    "requirements": []
                },
                {
                    "id": 22,
                    "title": "Hero Roulette",
                    "duration": 3,
                    "isRepeating": true,
                    "occurrenceInterval": 14,
                    "firstOccurrenceDay": 15,
                    "category": "hog",
                    "firstOccurrenceWeekday": "Tuesday",
                    "isFixed": true,
                    "fixedColumn": 1,
                    "requirements": ["2nd, Saul"]
                },
                {
                    "id": 23,
                    "title": "All Out",
                    "duration": 3,
                    "isRepeating": true,
                    "occurrenceInterval": 28,
                    "firstOccurrenceDay": 15,
                    "category": "hog",
                    "firstOccurrenceWeekday": "Friday",
                    "isFixed": false,
                    "requirements": []
                },
                {
                    "id": 24,
                    "title": "Working Overtime",
                    "duration": 2,
                    "isRepeating": true,
                    "occurrenceInterval": 14,
                    "firstOccurrenceDay": 22,
                    "category": "power-up",
                    "maxOccurrences": 2,
                    "isFixed": true,
                    "fixedColumn": 1,
                    "note": "Raise 1 Power through Construction, Raise 1 Power through Research, promote troops",
                    "requirements": []
                },
            ]
        };

        // Timeline state
        let currentStartDay = 1;
        let visibleDays = 50;
        let startWeekday = 0; // Sunday
        let timelineData = [];
        let eventColumns = [];
        let preCalculatedOccurrences = [];
        let maxPreCalculatedDay = 1000; // Pre-calculate events up to day 1000
        let eventVisibility = {}; // Track visibility state of events

        // Weekday names
        const weekdays = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];

        // Function to sanitize event titles for use as identifiers
        function sanitizeTitle(title) {
            return title.toLowerCase()
                .replace(/[^a-z0-9\-\s]/g, '') // Remove special characters
                .replace(/\s+/g, '-') // Replace spaces with hyphens
                .replace(/-+/g, '-') // Replace multiple hyphens with single hyphen
                .replace(/^-|-$/g, ''); // Remove leading/trailing hyphens
        }

        // Function to get CSS class name for an event
        function getEventCssClass(event) {
            return 'event-' + sanitizeTitle(event.title);
        }

        const emojiMap = {
            'construction': 'üèóÔ∏è',
            'research': 'üìö',
            'roulette': 'üé≤',
            'shard': 'üíé',
            'hero': 'ü¶∏',
            'bread': 'üçû',
            'wood': 'ü™µ',
            'stone': 'ü™®',
            'iron': '‚õèÔ∏è',
            'troops': '‚öîÔ∏è',
            'training': '‚öîÔ∏è',
            'promoting': '‚¨ÜÔ∏è',
            'stamina': '‚ö°',
            'speedup': '‚è±Ô∏è',
            'gear': 'üõ°Ô∏è',
            'forgehammer': 'üî®',
            'enhancement': '‚¨ÜÔ∏è',
            'widget': 'üîß',
            'resources': 'üì¶',
            'skill': 'üìñ',
            'manual': 'üìó'
        };
        const emojiMapKeys = Object.keys(emojiMap); // Cache the keys once

        // Function to convert note text to appropriate emojis
        function noteToEmoji(note) {
            if (!note) return '';

            var notes = note.split(/,\s*/);
            let emojis = '';
            // Convert text to lowercase for matching
            const lowerNote = note.toLowerCase();

            for (let i = 0; i < notes.length; i++) {
                const originalNote = notes[i];
                const lowerNote = originalNote.toLowerCase();

                for (let j = 0; j < emojiMapKeys.length; j++) {
                    const key = emojiMapKeys[j];
                    if (lowerNote.includes(key)) {
                        emojis += `<span title="${originalNote}" alt="${originalNote}">${emojiMap[key]}</span>`;
                        break;
                    }
                }
            }


            // If no specific emoji found, use a generic info emoji
            return emojis || '‚ÑπÔ∏è';
        }

        // Initialize timeline when page loads
        document.addEventListener('DOMContentLoaded', function () {
            initializeControls();
            generateTimeline();
        });

        function initializeControls() {
            // Start weekday selector
            document.getElementById('startWeekday').addEventListener('change', function () {
                startWeekday = parseInt(this.value);
                generateTimeline();
            });

            // Initialize event visibility (all events visible by default)
            sampleEventsData.events.forEach(event => {
                eventVisibility[sanitizeTitle(event.title)] = true;
            });

            // Generate event list
            generateEventList();
        }

        function generateEventList() {
            const container = document.getElementById('eventListContainer');
            container.innerHTML = '';

            sampleEventsData.events.forEach(event => {
                const sanitizedTitle = sanitizeTitle(event.title);
                const eventToggle = document.createElement('div');
                eventToggle.className = `event-toggle ${event.category} ${eventVisibility[sanitizedTitle] ? '' : 'disabled'}`;
                eventToggle.onclick = () => toggleEvent(sanitizedTitle);

                eventToggle.innerHTML = `
                    <div class="toggle-switch ${eventVisibility[sanitizedTitle] ? 'active' : ''}">
                        <div class="toggle-slider"></div>
                    </div>
                    <div class="event-toggle-content">
                        <div class="event-toggle-title">${event.title}</div>
                        <div class="event-toggle-info">
                            Duration: ${event.duration} days
                            ${event.isRepeating ? ` ‚Ä¢ Repeats every ${event.occurrenceInterval} days` : ''}
                            ${event.requirements.length > 0 ? `<br>${event.requirements.join(', ')}` : ''}
                        </div>
                    </div>
                `;
                container.appendChild(eventToggle);
            });
        }

        function getWeekdayForDay(day) {
            return weekdays[(startWeekday + day - 1) % 7];
        }

        function calculateEventOccurrences(event, maxDay) {
            const occurrences = [];

            if (!event.isRepeating) {
                // Single occurrence event
                let startDay = event.firstOccurrenceDay;

                // If event has a specific weekday requirement, adjust the start day
                if (event.firstOccurrenceWeekday) {
                    startDay = adjustForWeekday(startDay, event.firstOccurrenceWeekday);
                }

                if (startDay <= maxDay) {
                    occurrences.push({
                        startDay: startDay,
                        endDay: startDay + event.duration - 1,
                        event: event
                    });
                }
            } else {
                // Repeating event
                let occurrenceCount = 0;
                let currentStartDay = event.firstOccurrenceDay;

                // If event has a specific weekday requirement, adjust the start day
                if (event.firstOccurrenceWeekday) {
                    currentStartDay = adjustForWeekday(currentStartDay, event.firstOccurrenceWeekday);
                }

                while (currentStartDay <= maxDay && (!event.maxOccurrences || occurrenceCount < event.maxOccurrences)) {
                    occurrences.push({
                        startDay: currentStartDay,
                        endDay: currentStartDay + event.duration - 1,
                        event: event
                    });

                    currentStartDay += event.occurrenceInterval;
                    occurrenceCount++;
                }
            }

            return occurrences;
        }

        function adjustForWeekday(baseDay, targetWeekdayName) {
            // Convert weekday name to number
            const weekdayMap = {
                'Sunday': 0, 'Monday': 1, 'Tuesday': 2, 'Wednesday': 3,
                'Thursday': 4, 'Friday': 5, 'Saturday': 6
            };

            const targetWeekday = weekdayMap[targetWeekdayName];
            if (targetWeekday === undefined) {
                return baseDay; // Return original if weekday name is invalid
            }

            // Calculate what weekday the baseDay falls on
            const baseDayWeekday = (startWeekday + baseDay - 1) % 7;

            // Calculate how many days to adjust to reach the target weekday
            let adjustment = targetWeekday - baseDayWeekday;
            if (adjustment < 0) {
                adjustment += 7; // Move to next week if target day has passed
            }

            return baseDay + adjustment;
        }

        function preCalculateAllOccurrences() {
            // Pre-calculate all event occurrences up to maxPreCalculatedDay
            const allOccurrences = [];

            sampleEventsData.events.forEach(event => {
                const occurrences = calculateEventOccurrences(event, maxPreCalculatedDay);
                allOccurrences.push(...occurrences);
            });

            // Sort by start day, then by event priority (fixed events first)
            allOccurrences.sort((a, b) => {
                if (a.startDay !== b.startDay) return a.startDay - b.startDay;
                // Fixed events get priority
                if (a.event.isFixed && !b.event.isFixed) return -1;
                if (!a.event.isFixed && b.event.isFixed) return 1;
                return 0;
            });

            return allOccurrences;
        }

        function determineEventColumns() {
            // Pre-calculate all occurrences if not done already
            if (preCalculatedOccurrences.length === 0) {
                preCalculatedOccurrences = preCalculateAllOccurrences();
            }

            // Determine which columns are reserved for fixed events (from all events, not just current occurrences)
            const reservedColumns = new Set();
            sampleEventsData.events.forEach(event => {
                if (event.isFixed && event.fixedColumn !== undefined) {
                    reservedColumns.add(event.fixedColumn);
                }
            });

            // Determine the maximum number of fixed columns needed
            let maxFixedColumn = Math.max(...Array.from(reservedColumns), -1);

            // Initialize columns array with enough space for fixed columns
            const columns = [];
            for (let i = 0; i <= maxFixedColumn; i++) {
                columns[i] = [];
            }

            // First pass: assign fixed events to their designated columns
            preCalculatedOccurrences.forEach(occurrence => {
                if (occurrence.event.isFixed && occurrence.event.fixedColumn !== undefined) {
                    const colIndex = occurrence.event.fixedColumn;
                    columns[colIndex].push(occurrence);
                    occurrence.assignedColumn = colIndex; // Track assignment
                }
            });

            // Second pass: efficiently pack non-fixed events into available spaces (skip reserved columns)
            preCalculatedOccurrences.forEach(occurrence => {
                if (!occurrence.event.isFixed || occurrence.event.fixedColumn === undefined) {
                    let assignedColumn = -1;

                    // Try to find the first available column that can accommodate this event
                    // Skip columns that are reserved for fixed events
                    for (let colIndex = 0; colIndex < columns.length; colIndex++) {
                        if (!reservedColumns.has(colIndex) && canFitInColumn(occurrence, columns[colIndex])) {
                            columns[colIndex].push(occurrence);
                            occurrence.assignedColumn = colIndex;
                            assignedColumn = colIndex;
                            break;
                        }
                    }

                    // If no existing column can fit this event, create a new one
                    if (assignedColumn === -1) {
                        columns.push([occurrence]);
                        occurrence.assignedColumn = columns.length - 1;
                    }
                }
            });

            // Ensure all reserved columns exist (even if empty)
            reservedColumns.forEach(colIndex => {
                if (!columns[colIndex]) {
                    columns[colIndex] = [];
                }
            });

            // Fill any gaps in the columns array to maintain proper indexing
            const maxColumnIndex = Math.max(columns.length - 1, maxFixedColumn);
            for (let i = 0; i <= maxColumnIndex; i++) {
                if (!columns[i]) {
                    columns[i] = [];
                }
            }

            return columns;
        }

        function canFitInColumn(newOccurrence, columnOccurrences) {
            // Check if the new occurrence overlaps with any existing occurrence in the column
            return !columnOccurrences.some(existing =>
                !(newOccurrence.endDay < existing.startDay || newOccurrence.startDay > existing.endDay)
            );
        }

        function generateTimeline() {
            const table = document.getElementById('timelineTable');
            const header = document.getElementById('timelineHeader');
            const body = document.getElementById('timelineBody');

            // Clear existing content
            header.innerHTML = '';
            body.innerHTML = '';

            // Reset pre-calculated occurrences when timeline parameters change
            preCalculatedOccurrences = [];

            // Calculate event columns (this will trigger pre-calculation)
            eventColumns = determineEventColumns();

            // Create header row
            const headerRow = document.createElement('tr');
            headerRow.innerHTML = '<th class="day-header">Day</th>';

            // Add event column headers
            for (let i = 0; i < eventColumns.length; i++) {
                const th = document.createElement('th');
                th.className = 'event-header';
                th.textContent = `Events ${i + 1}`;
                headerRow.appendChild(th);
            }

            header.appendChild(headerRow);

            // Generate timeline rows
            for (let day = currentStartDay; day < currentStartDay + visibleDays; day++) {
                const row = document.createElement('tr');
                row.className = 'timeline-row';

                // Day number cell (combined with weekday)
                const dayCell = document.createElement('td');
                dayCell.className = 'day-cell';
                dayCell.innerHTML = `<div class="day-number">${day}</div><div class="weekday">${getWeekdayForDay(day)}</div>`;
                row.appendChild(dayCell);

                // Event cells
                for (let colIndex = 0; colIndex < eventColumns.length; colIndex++) {
                    const eventCell = document.createElement('td');
                    eventCell.className = 'event-cell';

                    // Check if any visible event in this column occurs on this day
                    const eventsOnThisDay = eventColumns[colIndex].filter(occurrence =>
                        day >= occurrence.startDay && day <= occurrence.endDay && eventVisibility[sanitizeTitle(occurrence.event.title)]
                    );

                    if (eventsOnThisDay.length > 0) {
                        const occurrence = eventsOnThisDay[0];
                        const event = occurrence.event;
                        const dayInEvent = day - occurrence.startDay + 1;

                        eventCell.className += ` ${getEventCssClass(event)}`;

                        // Add event title on first day
                        if (day === occurrence.startDay) {
                            eventCell.innerHTML = `
                                <div class="event-title">${event.title}</div>
                                <div class="event-info">Day ${dayInEvent}</div>
                            `;
                        } else {
                            eventCell.innerHTML = `
                                <div class="event-info">Day ${dayInEvent}</div>
                            `;
                        }

                        // Add stage information if available
                        if (event.hasStages && event.stages && event.stages[dayInEvent - 1]) {
                            const stage = event.stages[dayInEvent - 1];
                            if (stage.note) {
                                var emoji = noteToEmoji(stage.note);
                                eventCell.innerHTML += `<div class="stage-note">${emoji}</div>`;
                            }
                        }

                        // Add general note if it's the first day
                        if (day === occurrence.startDay && event.note) {
                            eventCell.innerHTML += `<div class="event-note">${event.note}</div>`;
                        }

                        // Add requirements on first day
                        if (day === occurrence.startDay && event.requirements.length > 0) {
                            eventCell.innerHTML += `<div class="requirements">${event.requirements.join(', ')}</div>`;
                        }
                    }

                    row.appendChild(eventCell);
                }

                body.appendChild(row);
            }

            // Add infinite scroll
            addInfiniteScroll();
        }

        function addInfiniteScroll() {
            const container = document.getElementById('timelineContainer');

            container.addEventListener('scroll', function () {
                if (container.scrollTop + container.clientHeight >= container.scrollHeight - 100) {
                    // Load more days
                    loadMoreDays();
                }
            });
        }

        function toggleEvent(sanitizedTitle) {
            eventVisibility[sanitizedTitle] = !eventVisibility[sanitizedTitle];
            generateEventList();
            generateTimeline();
        }

        function toggleAllEvents(show) {
            sampleEventsData.events.forEach(event => {
                eventVisibility[sanitizeTitle(event.title)] = show;
            });
            generateEventList();
            generateTimeline();
        }

        function toggleByCategory(category) {
            const eventsInCategory = sampleEventsData.events.filter(event => event.category === category);
            const allVisible = eventsInCategory.every(event => eventVisibility[sanitizeTitle(event.title)]);

            eventsInCategory.forEach(event => {
                eventVisibility[sanitizeTitle(event.title)] = !allVisible;
            });

            generateEventList();
            generateTimeline();
        }

        function loadMoreDays() {
            const body = document.getElementById('timelineBody');
            const additionalDays = 20;
            const startDay = currentStartDay + visibleDays;

            for (let day = startDay; day < startDay + additionalDays; day++) {
                const row = document.createElement('tr');
                row.className = 'timeline-row';

                // Day number cell (combined with weekday)
                const dayCell = document.createElement('td');
                dayCell.className = 'day-cell';
                dayCell.innerHTML = `<div class="day-number">${day}</div><div class="weekday">${getWeekdayForDay(day)}</div>`;
                row.appendChild(dayCell);

                // Event cells - use the pre-calculated column assignments
                for (let colIndex = 0; colIndex < eventColumns.length; colIndex++) {
                    const eventCell = document.createElement('td');
                    eventCell.className = 'event-cell';

                    // Find visible events that occur on this day in this column
                    const eventsOnThisDay = eventColumns[colIndex].filter(occurrence =>
                        day >= occurrence.startDay && day <= occurrence.endDay && eventVisibility[sanitizeTitle(occurrence.event.title)]
                    );

                    if (eventsOnThisDay.length > 0) {
                        const occurrence = eventsOnThisDay[0];
                        const event = occurrence.event;
                        const dayInEvent = day - occurrence.startDay + 1;

                        eventCell.className += ` ${getEventCssClass(event)}`;

                        // Add event title on first day
                        if (day === occurrence.startDay) {
                            eventCell.innerHTML = `
                                <div class="event-title">${event.title}</div>
                                <div class="event-info">Day ${dayInEvent}/${event.duration}</div>
                            `;
                        } else {
                            eventCell.innerHTML = `
                                <div class="event-info">Day ${dayInEvent}/${event.duration}</div>
                            `;
                        }

                        // Add stage information if available
                        if (event.hasStages && event.stages && event.stages[dayInEvent - 1]) {
                            const stage = event.stages[dayInEvent - 1];
                            if (stage.note) {
                                var emoji = noteToEmoji(stage.note);
                                eventCell.innerHTML += `<div class="stage-note">${emoji}</div>`;
                            }
                        }

                        // Add general note if it's the first day
                        if (day === occurrence.startDay && event.note) {
                            eventCell.innerHTML += `<div class="event-note">${event.note}</div>`;
                        }

                        // Add requirements on first day
                        if (day === occurrence.startDay && event.requirements.length > 0) {
                            eventCell.innerHTML += `<div class="requirements">${event.requirements.join(', ')}</div>`;
                        }
                    }

                    row.appendChild(eventCell);
                }

                body.appendChild(row);
            }

            visibleDays += additionalDays;
        }

        // Modal functions
        function openEventInfoModal() {
            const modal = document.getElementById('eventInfoModal');
            modal.classList.add('show');
            document.body.style.overflow = 'hidden'; // Prevent background scrolling
        }

        function closeEventInfoModal() {
            const modal = document.getElementById('eventInfoModal');
            modal.classList.remove('show');
            document.body.style.overflow = 'auto'; // Restore scrolling
        }

        // Close modal when clicking outside of it
        document.getElementById('eventInfoModal').addEventListener('click', function (e) {
            if (e.target === this) {
                closeEventInfoModal();
            }
        });

        // Close modal with Escape key
        document.addEventListener('keydown', function (e) {
            if (e.key === 'Escape') {
                const modal = document.getElementById('eventInfoModal');
                if (modal.classList.contains('show')) {
                    closeEventInfoModal();
                }
            }
        });
    </script>
</body>

</html>
